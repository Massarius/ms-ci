# Copyright 2020 Google LLC
#
# Licensed under the Apache License, Version 2.0 (the "License");
# you may not use this file except in compliance with the License.
# You may obtain a copy of the License at
#
#      http://www.apache.org/licenses/LICENSE-2.0
#
# Unless required by applicable law or agreed to in writing, software
# distributed under the License is distributed on an "AS IS" BASIS,
# WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
# See the License for the specific language governing permissions and
# limitations under the License.

# Standard values.yaml can be found at: 
# https://github.com/helm/charts/blob/master/stable/jenkins/values.yaml
controller:
  tag: "2.300"
  containerEnv:
    - name: PROJECT_ID
      valueFrom:
        secretKeyRef:
            name: jenkins-k8s-config
            key: project_id
    - name: GITHUB_REPO
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_repo
    - name: GITHUB_USERNAME
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_username
    - name: GITHUB_TOKEN
      valueFrom:
        secretKeyRef:
            name: github-secrets
            key: github_token
    - name: jenkins_tf_ksa
      valueFrom:
        secretKeyRef:
            name: jenkins-k8s-config
            key: jenkins_tf_ksa
  servicePort: 80
  serviceType: LoadBalancer
  installPlugins:
      # - blueocean-dashboard:latest # 💠D-BlueOcean ️  
      - checks-api:1.7.4 # checks customization
      # - pipeline-stage-view:2.24 # 💠D-Pipeline
      # - ssh-credentials:latest #    💠D-Credentials
      - popper2-api:2.11.5-2 # JS tooltip functionality
      # - structs:latest 💠D-Credentials
      # - blueocean-core-js:latest # 💠D-BlueOcean
      # - momentjs:latest # ❌
      # - blueocean-personalization:latest 💠D-BlueOcean
      - sshd:3.242.va_db_9da_b_26a_c3 #  ❌ 
      - git-client:3.11.0 # allows git operations
      # - workflow-durable-task-step:latest 💠D-Pipeline;aka-p.nodes&processes
      # - workflow-cps-global-lib:latest ❌Deprecated.New⬇️
      # - pipeline-groovy-lib:598.vcd66b_a_336510 💠D-Pipeline
      # - popper-api:latest ❌ 
      # - workflow-basic-steps:latest 💠D-Pipeline
      # - pipeline-graph-analysis:195.v5812d95a_a_2f9 ✔️ 
      # - blueocean-pipeline-editor:latest 💠D-BlueOcean
      - workflow-aggregator:590.v6a_d052e5a_a_b_5 # aka Pipelines
      - plain-credentials:1.8
      - kubernetes-credentials:0.9.0
      - favorite:2.4.1
      # - blueocean-i18n:latest💠D-BlueOcean
      - workflow-support:833.va_1c71061486b_
      - github:1.34
      - configuration-as-code:1414.v878271fc496f
      # - display-url-api:2.3.6 #️ ✔️
      # - blueocean-config:latest 💠D-BlueOcean
      # - jenkins-design-language:latest  💠D-BlueOcean
      # - bootstrap4-api:latest 💠D?
      # - bouncycastle-api:latest 💠D?
      # - durable-task:latest 💠D?
      # - blueocean-git-pipeline:latest 💠D-BlueOcean
      # - blueocean-github-pipeline:1.25.5 💠D-BlueOcean
      # - font-awesome-api:latest 💠D?
      # - caffeine-api:latest 💠D?
      # - jackson2-api:latest 💠D?
      # - htmlpublisher:1.30 # 💠D?
      # - workflow-api:latest 💠D?
      # - pipeline-stage-step:latest 💠D-Pipeline
      - git:4.10.2
      # - workflow-job:latest 💠D-Pipeline
      - blueocean-pipeline-scm-api:1.25.5
      - pipeline-stage-tags-metadata:2.2114.v2654ca_721309
      # - jira:latest  ❌
      # - matrix-project:latest  ✔️ 
      # - jsch:latest  💠D
      # - lockable-resources:latest  💠D
      # - variant:latest 💠D~?
      # - git-server:latest 💠D
      # - cloudbees-bitbucket-branch-source:latest ❌ 
      # - trilead-api:latest 💠D  
      # - scm-api:latest  💠D
      # - docker-workflow:latest # ❌ 
      # - pubsub-light:latest 💠D
      # - jdk-tool:latest ❌?
      # - branch-api:latest 💠D?
      # - plugin-util-api:latest 💠D?
      - authentication-tokens:1.4
      - handlebars:latest # 💠perhaps-removable
      - pipeline-model-extensions:2.2114.v2654ca_721309 
      - token-macro:308.v4f2b_ed62b_b_16
      # - pipeline-rest-api:latest 💠D?
      # - blueocean-display-url:latest 💠D-BlueOcean
      # - jjwt-api:latest 💠D
      - mailer:438.v02c7f0a_12fa_4
      # - blueocean-autofavorite:latest  💠D-BlueOcean
      # - blueocean-commons:latest  💠D-BlueOcean
      - blueocean:1.25.5
      - command-launcher:80.v4a_97f2027398
      # - blueocean-rest:latest  💠D-BlueOcean
      - kubernetes:1.31.3
      # - apache-httpcomponents-client-4-api:latest 💠D?
      - cloudbees-folder:6.729.v2b_9d1a_74d673 
      - job-dsl:1.81
      # - blueocean-bitbucket-pipeline:latest  💠D-BlueOcean
      # - docker-commons:latest ❌
      # - bootstrap5-api:latest 💠D-BlueOcean
      # - blueocean-jira:latest  💠D-BlueOcean Optional
      # - pipeline-milestone-step:latest 💠D-BlueOcean
      # - blueocean-pipeline-api-impl:latest 💠D-BlueOcean
      # - pipeline-model-api:latest 💠D?
      # - pipeline-model-definition:latest 💠D-Pipeline
      # - echarts-api:latest ✔️ 
      # - docker-custom-build-environment:latest  ❌ 
      # - handy-uri-templates-2-api:latest 💠D?
      # - kubernetes-client-api:latest 💠D
      # - github-branch-source:latest ❌ 
      # - blueocean-jwt:latest  💠D-BlueOcean 
      # - pipeline-input-step:latest 💠D-Pipeline
      # - github-api:latest 💠D
      - junit:1119.1121.vc43d0fc45561
      - credentials-binding:latest
      - workflow-scm-step:400.v6b_89a_1317c9a_
      - pipeline-build-step:2.18
      - ace-editor:1.1
      # - blueocean-web:latest  💠D-BlueOcean 
      # - workflow-step-api:latest 💠D?
      - sse-gateway:1.25
      - credentials:1139.veb_9579fca_33b_
      # - okhttp-api:latest 💠D?
      # - snakeyaml-api:latest 💠D?
      # - blueocean-rest-impl:latest  💠D-BlueOcean 
      # - metrics:latest 💠D?
      # - blueocean-events:latest  💠D-BlueOcean 
      # - workflow-cps:latest  💠D-Pipeline
      # - jquery3-api:latest  💠D?
      # - script-security: ✔️
      # - workflow-multibranch:latest 💠D-Pipeline
  JCasC:
    enabled: true
    configScripts:
        cloud: |
            jenkins:
                clouds:
                    - kubernetes:
                        name: "gke-executors"
                        serverUrl: "https://kubernetes.default"
                        jenkinsTunnel: "jenkins-agent:50000"
                        jenkinsUrl: "http://jenkins:80"
                        skipTlsVerify: true
                        namespace: "default"
                        templates:
                            - name: "jenkins-jnlp"
                              namespace: "default"
                              nodeUsageMode: NORMAL
                              label: "jnlp-exec"
                              containers:
                                - name: "jnlp"
                                  image: "jenkins/jnlp-slave"
                                  alwaysPullImage: false
                                  workingDir: "/home/jenkins/agent"
                                  ttyEnabled: true
                                  command: ""
                                  args: ""
                                  resourceRequestCpu: "500m"
                                  resourceLimitCpu: "1000m"
                                  resourceRequestMemory: "1Gi"
                                  resourceLimitMemory: "2Gi"
                              volumes:
                                - emptyDirVolume:
                                    memory: false
                                    mountPath: "/tmp"
                              idleMinutes: "1"
                              activeDeadlineSeconds: "120"
                              slaveConnectTimeout: "1000"
                            - name: "terraform"
                              namespace: "default"
                              nodeUsageMode: NORMAL
                              serviceAccount: ${jenkins_tf_ksa}
                              label: "terraform-exec"
                              containers:
                                - name: "terraform"
                                  image: "hashicorp/terraform:0.12.29"
                                  alwaysPullImage: false
                                  workingDir: "/home/jenkins/agent"
                                  ttyEnabled: true
                                  command: "/bin/sh -c"
                                  args: "cat"
                                  resourceRequestCpu: "100m"
                                  resourceLimitCpu: "500m"
                                  resourceRequestMemory: "500Mi"
                                  resourceLimitMemory: "1Gi"
                              volumes:
                                - emptyDirVolume:
                                    memory: false
                                    mountPath: "/tmp"
                              podRetention: "never"
                              activeDeadlineSeconds: "300"
                              slaveConnectTimeout: "1000"
        credentials: |
            credentials:
                system:
                    domainCredentials:
                    - credentials:
                        - usernamePassword:
                            scope: GLOBAL
                            id: "github-token"
                            username: ${GITHUB_USERNAME}
                            password: ${GITHUB_TOKEN}
                            description: "Github personal token"
        init-jobs: |
            jobs:
              - script: >
                    multibranchPipelineJob('terraform-jenkins-create-env') {
                        factory {
                        workflowBranchProjectFactory {
                            scriptPath('pipelines/environments/Jenkinsfile')
                        }
                        }
                        branchSources {
                        github {
                            id('13374160')
                            scanCredentialsId('github-token')
                            repoOwner("${GITHUB_USERNAME}")
                            repository("${GITHUB_REPO}")
                            buildOriginBranch(true)
                            buildOriginPRMerge(true)
                            includes("dev prod PR*")
                        }
                        }
                        orphanedItemStrategy {
                        discardOldItems {
                            numToKeep(10)
                        }
                        }
                        triggers {
                        periodic(1)
                        }
                    }
